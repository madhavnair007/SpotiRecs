<!DOCTYPE html>
<html>

<head>
    <title>Album Builder</title>
    <link rel="stylesheet" href="recommendation_style.css">
    <style>
        .song-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background-color: #f9f9f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .song-info {
            flex-grow: 1;
        }
        
        .song-title {
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .song-artist {
            color: #666;
        }
        
        .song-genre {
            font-style: italic;
            color: #888;
        }
        
        .selected-songs {
            margin-top: 20px;
        }
        
        .selected-song {
            background-color: #e6f7ff;
            border-left: 4px solid #1890ff;
        }
        
        .search-results {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .album-container {
            margin-top: 30px;
        }
        
        .album-song {
            background-color: #f0f8ff;
            border-left: 4px solid #4caf50;
        }
        
        .step-container {
            margin-bottom: 30px;
        }
        
        .step-title {
            font-size: 1.2em;
            margin-bottom: 10px;
            color: #333;
        }
        
        .step-description {
            color: #666;
            margin-bottom: 15px;
        }
        
        .loading {
            text-align: center;
            margin: 20px 0;
            display: none;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .nav-links {
            text-align: center;
            margin: 20px 0;
        }
        
        .nav-link {
            display: inline-block;
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            margin: 0 10px;
        }
        
        .nav-link:hover {
            background-color: #45a049;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
    </style>
</head>

<body>
    <h1 class="mainHeading">Album Builder</h1>
    <p class="subtitle">Create a personalized album based on 3 songs you love</p>
    
    <div class="nav-links">
        <a href="/" class="nav-link">Back to Song Recommendation</a>
    </div>

    <div class="container">
        <div class="step-container">
            <div class="step-title">Step 1: Search for Songs</div>
            <div class="step-description">Search for songs by title or artist name</div>
            <div>
                <input type="text" id="searchQuery" placeholder="Enter song title or artist name">
                <button class="btn" onClick="searchSongs()">Search</button>
            </div>
            <div class="search-results" id="searchResults"></div>
        </div>

        <div class="step-container">
            <div class="step-title">Step 2: Select 3 Songs</div>
            <div class="step-description">Choose 3 songs to build your album around</div>
            <div class="selected-songs" id="selectedSongs">
                <p>Selected songs: <span id="selectedCount">0</span>/3</p>
                <div id="selectedSongsList"></div>
            </div>
        </div>

        <div class="step-container">
            <div class="step-title">Step 3: Build Your Album</div>
            <div class="step-description">Generate a personalized album based on your selected songs</div>
            <button class="btn" id="buildAlbumBtn" onClick="buildAlbum()" disabled>Build Album</button>
        </div>
    </div>
    
    <div class="loading" id="loadingIndicator">
        <div class="loading-spinner"></div>
        <p>Building your album...</p>
    </div>
    
    <div class="box" id="albumBox" style="display:none;">
        <h2>Your Personalized Album</h2>
        <div id="albumResult"></div>
        <button class="btn" onClick="saveAlbum()">Save Album</button>
    </div>

    <script>
        // Store selected songs
        let selectedSongs = [];
        
        // Search for songs
        function searchSongs() {
            const query = document.getElementById("searchQuery").value.trim();
            const searchResults = document.getElementById("searchResults");
            
            if (query === "") {
                searchResults.innerHTML = "<p>Please enter a search term.</p>";
                return;
            }
            
            // Show loading indicator
            searchResults.innerHTML = "<p>Searching...</p>";
            
            // Call the API
            fetch(`/cluster_album/search_songs?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        searchResults.innerHTML = `<p>Error: ${data.error}</p>`;
                        return;
                    }
                    
                    if (data.songs.length === 0) {
                        searchResults.innerHTML = "<p>No songs found. Try a different search term.</p>";
                        return;
                    }
                    
                    // Display search results
                    searchResults.innerHTML = "";
                    data.songs.forEach(song => {
                        const songCard = document.createElement("div");
                        songCard.className = "song-card";
                        
                        const songInfo = document.createElement("div");
                        songInfo.className = "song-info";
                        songInfo.innerHTML = `
                            <div class="song-title">${song.track_name}</div>
                            <div class="song-artist">${song.artist_name}</div>
                            <div class="song-genre">${song.genre} (${song.year})</div>
                        `;
                        
                        const selectButton = document.createElement("button");
                        selectButton.className = "btn";
                        selectButton.textContent = isSongSelected(song.index) ? "Remove" : "Select";
                        selectButton.onclick = () => toggleSongSelection(song);
                        
                        songCard.appendChild(songInfo);
                        songCard.appendChild(selectButton);
                        searchResults.appendChild(songCard);
                    });
                })
                .catch(error => {
                    searchResults.innerHTML = `<p>Error: ${error.message}</p>`;
                });
        }
        
        // Check if a song is already selected
        function isSongSelected(index) {
            return selectedSongs.some(song => song.index === index);
        }
        
        // Toggle song selection
        function toggleSongSelection(song) {
            const index = selectedSongs.findIndex(s => s.index === song.index);
            
            if (index === -1) {
                // Add song if we have less than 3 songs
                if (selectedSongs.length < 3) {
                    selectedSongs.push(song);
                } else {
                    alert("You can only select 3 songs. Remove one first.");
                    return;
                }
            } else {
                // Remove song
                selectedSongs.splice(index, 1);
            }
            
            // Update UI
            updateSelectedSongsUI();
            updateBuildButtonState();
        }
        
        // Update the selected songs UI
        function updateSelectedSongsUI() {
            const selectedSongsList = document.getElementById("selectedSongsList");
            const selectedCount = document.getElementById("selectedCount");
            
            selectedCount.textContent = selectedSongs.length;
            
            if (selectedSongs.length === 0) {
                selectedSongsList.innerHTML = "<p>No songs selected yet.</p>";
                return;
            }
            
            selectedSongsList.innerHTML = "";
            selectedSongs.forEach(song => {
                const songCard = document.createElement("div");
                songCard.className = "song-card selected-song";
                
                const songInfo = document.createElement("div");
                songInfo.className = "song-info";
                songInfo.innerHTML = `
                    <div class="song-title">${song.track_name}</div>
                    <div class="song-artist">${song.artist_name}</div>
                    <div class="song-genre">${song.genre} (${song.year})</div>
                `;
                
                const removeButton = document.createElement("button");
                removeButton.className = "btn";
                removeButton.textContent = "Remove";
                removeButton.onclick = () => toggleSongSelection(song);
                
                songCard.appendChild(songInfo);
                songCard.appendChild(removeButton);
                selectedSongsList.appendChild(songCard);
            });
        }
        
        // Update the build button state
        function updateBuildButtonState() {
            const buildAlbumBtn = document.getElementById("buildAlbumBtn");
            buildAlbumBtn.disabled = selectedSongs.length !== 3;
        }
        
        // Build the album
        function buildAlbum() {
            if (selectedSongs.length !== 3) {
                alert("Please select exactly 3 songs.");
                return;
            }
            
            const loadingIndicator = document.getElementById("loadingIndicator");
            const albumBox = document.getElementById("albumBox");
            const albumResult = document.getElementById("albumResult");
            
            // Show loading indicator
            loadingIndicator.style.display = "block";
            albumBox.style.display = "none";
            
            // Get song indices
            const songIndices = selectedSongs.map(song => song.index);
            
            // Call the API
            fetch('/cluster_album/build_album', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    song_indices: songIndices,
                    num_songs: 10
                }),
            })
            .then(response => response.json())
            .then(data => {
                // Hide loading indicator
                loadingIndicator.style.display = "none";
                
                if (data.error) {
                    albumResult.innerHTML = `<p>Error: ${data.error}</p>`;
                    albumBox.style.display = "block";
                    return;
                }
                
                // Display album
                albumResult.innerHTML = "";
                data.album.forEach((song, index) => {
                    const songCard = document.createElement("div");
                    songCard.className = "song-card album-song";
                    
                    const songInfo = document.createElement("div");
                    songInfo.className = "song-info";
                    songInfo.innerHTML = `
                        <div class="song-title">${index + 1}. ${song.track_name}</div>
                        <div class="song-artist">${song.artist_name}</div>
                        <div class="song-genre">${song.genre} (${song.year})</div>
                    `;
                    
                    songCard.appendChild(songInfo);
                    albumResult.appendChild(songCard);
                });
                
                albumBox.style.display = "block";
            })
            .catch(error => {
                loadingIndicator.style.display = "none";
                albumResult.innerHTML = `<p>Error: ${error.message}</p>`;
                albumBox.style.display = "block";
            });
        }
        
        // Save the album
        function saveAlbum() {
            alert("Album saved! (This is a placeholder - implement actual saving functionality)");
        }
        
        // Initialize the UI
        function initUI() {
            updateSelectedSongsUI();
            updateBuildButtonState();
        }
        
        // Initialize when the page loads
        window.onload = initUI;
    </script>
</body>

</html> 